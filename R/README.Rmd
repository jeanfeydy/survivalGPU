---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "70%"
)
```

# survivalGPU <img src="man/figures/logo.png" align="right" height="139" />

<!-- badges: start -->
[![R-CMD-check](https://github.com/jeanfeydy/survivalGPU/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/jeanfeydy/survivalGPU/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The survivalGPU library allows you to perform survival analyzes using the resources of Graphic Processing Units (GPU) in order to accelerate the speed of calculations. Currently, two models have been implemented :  

* Cox Proportional Hazards regression model  
* Weighted Cumulative Exposure model  

It's also possible to use the library without having Graphics Processing Units (with CPU).

## Installation

survivalGPU is a package based on a package written in python, dependant on the `reticulate` R package. To use it, it's necessary to have installed some python libraries such as `torch`, `torch-scatter`, and `pykeops`. To use survivalGPU, you can create a virtual python environment through `reticulate`. It's highly recommended to not to use the default python executable. 

```{r, eval=FALSE}
library(reticulate)

virtualenv_create("survivalGPU")
virtualenv_install("survivalGPU", packages = c("torch", "torch_scatter",
                                               "pykeops", "matplotlib",
                                               "beartype", "jaxtyping"))
# torch takes a long time to set up
```

To configure properly and understand your python environment, check `vignette("python_connect")`  

survivalGPU require submodules : you can install the development version of survivalGPU from [GitHub](https://github.com/) with `install_git_with_submodule()`:

```{r, eval=FALSE}
# install.packages("devtools")

install_git_with_submodule <- function(x, subdir) {
  install_dir <- tempfile()
  system(paste("git clone --recursive", shQuote(x), shQuote(install_dir)))
  
  # change name for windows install
  file.rename(file.path(install_dir, "R/inst/python/survivalgpu"),
              file.path(install_dir, "R/inst/python/survivalgpu_submodule"))
  file.copy(file.path(install_dir, "python/survivalgpu"),
            file.path(install_dir, "R/inst/python"), recursive = TRUE)
  
  devtools::install(file.path(file.path(install_dir, subdir)))
}

install_git_with_submodule("https://github.com/jeanfeydy/survivalGPU",
                           subdir = "R")
```

> **Warning**: Currently, survivalGPU is not available for Windows.  

## Example

Let's make a small example for a Cox PH model with `lung` cancer dataset from `survival` package. Before load `survivalGPU`, use your virtual python environment (see above or `vignette("python_connect")`).

```{r}
library(reticulate)
use_virtualenv(virtualenv = "survivalGPU")
```


```{r example, message=FALSE}
library(survivalGPU)
library(survival)
```

Check if CUDA is detected :

```{r}
use_cuda()
```

By default, functions run with GPU if detected. Then we specify the number of bootstrap, and consequently the batchsize argument, according to CUDA drivers detection.

```{r}
if (use_cuda()) {
  n_bootstrap <- 1000
  batchsize <- 200
} else {
  n_bootstrap <- 50
  batchsize <- 10
}
```

You can realize the Cox model with the `coxphGPU()` function, which is written in the same way as the `survival::coxph()` function from survival package, with a Surv object in the formula.

```{r coxphGPU}
coxphGPU_bootstrap <- coxphGPU(Surv(time, status) ~ age + sex + ph.ecog,
                               data = lung,
                               bootstrap = n_bootstrap,
                               batchsize = batchsize,
                               ties = "breslow")
```

With `summary` method, you obtain results for initial model, and a confidence interval by normal distribution process. A confidence interval is also estimated for coefficients by bootstrap (if bootstrap > 1 in your coxphGPU object). 

```{r}
summary(coxphGPU_bootstrap)
```

To visualize your model, you can plot adjusted survival curves with `survminer::ggadjustedcurves()`.

```{r}
survminer::ggadjustedcurves(coxphGPU_bootstrap,
                            variable = "sex",
                            data = lung)
```

If you have no model, it's possible to estimate survival curves with Kaplan-Meier estimation by `survival::survfit()`, and you can use `survminer::ggsurvplot()` to plot a Kaplan-Meier survival curve.  

Moreover, it's possible to evaluate proportional hazards assumption, and plot a forestplot of your model. All is explain in the `vignette("coxPH")`.

## Vignettes

* `vignette("coxPH")`  
* `vignette("WCE")`  
* `vignette("python_connect")`  
